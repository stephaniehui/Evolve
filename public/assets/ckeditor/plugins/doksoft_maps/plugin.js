CKEDITOR.plugins.add("doksoft_maps",{icons:"doksoft_maps",init:function(e){CKEDITOR.config.doksoft_maps_width=e.config.doksoft_maps_width||400,CKEDITOR.config.doksoft_maps_height=e.config.doksoft_maps_height||320,CKEDITOR.config.doksoft_maps_default_x=e.config.doksoft_maps_default_x||-25.363882,CKEDITOR.config.doksoft_maps_default_y=e.config.doksoft_maps_default_y||131.044922,CKEDITOR.config.doksoft_maps_default_zoom=e.config.doksoft_maps_default_zoom||4,CKEDITOR.config.doksoft_maps_auto_scaling_on_search=e.config.doksoft_maps_auto_scaling_on_search||!0,e.path=this.path,CKEDITOR.dialog.add("doksoft_maps",this.path+"dialogs/doksoft_maps.js"),cmd=e.addCommand("doksoft_maps",new CKEDITOR.dialogCommand("doksoft_maps")),e.ui.addButton("doksoft_maps",{title:"Add or edit Google Map",command:"doksoft_maps",icon:this.path+"icons/doksoft_maps.png"}),e.contextMenu&&(e.addMenuGroup("doksoft_maps_group"),e.addMenuItem("doksoft_maps_item",{label:"Edit the map",command:"doksoft_maps",icon:this.path+"icons/doksoft_maps.png",group:"doksoft_maps_group"}),e.contextMenu.addListener(function(e){return e&&e.is("img")&&"doksoft_maps_img"==e.$.className?{doksoft_maps_item:CKEDITOR.TRISTATE_OFF}:void 0})),generateStatMap=function(e){return"http://maps.google.com/maps/api/staticmap?center="+e.lat+","+e.lng+"&zoom="+e.zoom+"&size="+e.width+"x"+e.height+"&maptype="+e.type+"&markers="+function(e){var t=[];for(var n in e)t.push(e[n][0]+","+e[n][1]);return t.join("|")}(e.objects.Marker)+"&sensor=false"},e.on("doubleclick",function(e){var t=e.data.element;t&&t.is("img")&&"doksoft_maps_img"==t.$.className&&(e.data.dialog="doksoft_maps")});var t=1,n="";this.softed=0,this.unprotectSource=function(i){return/<script[^>]*class[\s]*=[\s]*"doksoft_maps_google"[^>]*>/gi.test(i)||(n+='<script class="doksoft_maps_google" src="http://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places,weather"></script>',n+='<script class="doksoft_maps_google" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerwithlabel/src/markerwithlabel_packed.js"></script>'),/<script[^>]*class[\s]*=[\s]*"doksoft_maps_loadmap"[^>]*>/gi.test(i)||(n+="<script class=\"doksoft_maps_loadmap\">_loadmap = function(id,json){var canva = document.getElementById(id);canva.style.width=json.width+\"px\";canva.style.height=json.height+\"px\";var map = new google.maps.Map(canva,{zoom: parseInt(json.zoom),center: new google.maps.LatLng(parseFloat(json.lat),parseFloat(json.lng)),mapTypeId:json.type});if( json.settings ){ for( var id in json.settings )map.set(id,json.settings[id]?true:false);};if( json.objects ) for( var type in json.objects ){  for( var i in json.objects[type] ){var object = 0;switch( type ){case 'Marker':object = new google.maps.Marker({position: new google.maps.LatLng( json.objects[type][i][0], json.objects[type][i][1]),map: map,title: json.objects[type][i][2]});(function(txt){google.maps.event.addListener(object, 'click', function() {(new google.maps.InfoWindow({content: txt})).open( map,object );});})(json.objects[type][i][2]);break;case 'Rectangle':object = new google.maps.Rectangle({bounds: new google.maps.LatLngBounds(new google.maps.LatLng( json.objects[type][i][0][0], json.objects[type][i][0][1]),new google.maps.LatLng( json.objects[type][i][1][0], json.objects[type][i][1][1])),map: map,});break;case 'Polygon':case 'Polyline':var path = json.objects[type][i],array_path = [];for( var j in path )array_path.push(new google.maps.LatLng( path[j][0], path[j][1]));object = new google.maps[type]({path: array_path,map: map,});break;case 'Text':object = new MarkerWithLabel({position: new google.maps.LatLng( json.objects[type][i][0], json.objects[type][i][1]),map: map,labelContent: json.objects[type][i][2],labelAnchor: new google.maps.Point(22, 0),labelClass: \"labels\",labelStyle: {opacity: 1.0, minWidth:'200px',textAlign:'left'},icon: {}});break;case 'Circle':object = new google.maps.Circle({radius: json.objects[type][i][2],center:new google.maps.LatLng( json.objects[type][i][0], json.objects[type][i][1]),map: map,});break;case 'WeatherLayer':object = new google.maps.weather.WeatherLayer({temperatureUnits: google.maps.weather.TemperatureUnit.FAHRENHEIT});object.setMap(map);break;case 'TrafficLayer':object = new google.maps.TrafficLayer();object.setMap(map);break;}  } }};loadmap = function( id,json ){google.maps.event.addDomListener(window, 'load', function(){_loadmap(id,json)});};</script>"),i.replace(/<img[^>]+?class[\s]*=[\s]*"doksoft_maps_img"[\s]*contenteditable="false"[\s]*data_script="([^"]*)"([^>]*)\/>/g,function(n,i){return e.plugins.doksoft_maps.softed=1,t++,'<div id="doksoft_maps'+t+'"></div><script class="doksoft_maps">loadmap("doksoft_maps'+t+'",'+decodeURIComponent(i)+");</script>"})};var i=function(e){return e.replace(/^loadmap\("doksoft_maps[0-9]+",/,"").replace(/\);$/,"")};this.protectSource=function(e){return e.replace(/<script[^>]*class[\s]*=[\s]*"doksoft_maps"[^>]*>([^<]+)<\/script>/gi,function(e,t){var n="",a=i(t);try{n='<img class="doksoft_maps_img" contenteditable="false" data_script="'+encodeURIComponent(a)+'" src="'+generateStatMap(JSON.parse(a))+'"/>'}catch(o){n=e}return n}).replace(/<div[^>]*id[\s]*=[\s]*"doksoft_maps[0-9]+"><\/div>/gi,"")},e.on("toHtml",function(e){e.data.dataValue=CKEDITOR.plugins.registered.doksoft_maps.protectSource(e.data.dataValue)},null,null,1)},afterInit:function(e){!function(e){var t=e.dataProcessor,n=t&&t.htmlFilter,i=t&&t.dataFilter,a=e.plugins.doksoft_maps;i.addRules({comment:function(e){return e},elements:{img:function(){},div:function(){}}}),n.addRules({elements:{img:function(e){return e}}}),t.toDataFormat=CKEDITOR.tools.override(t.toDataFormat,function(e){return function(t,n){var i=e.call(this,t,n);soft="";var o=a.unprotectSource(i);return i=(a.softed?soft:"")+o}}),t.toHtml=CKEDITOR.tools.override(t.toHtml,function(e){return function(t,n){var i=a.protectSource(t),o=e.call(this,i,n);return o}})}(e)}}),CKEDITOR.config.doksoft_maps_width=CKEDITOR.config.doksoft_maps_width||400,CKEDITOR.config.doksoft_maps_height=CKEDITOR.config.doksoft_maps_height||320;